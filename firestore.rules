rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Funciones de Ayuda (Sintaxis corregida para Firebase CEL)
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Obtiene el rol directamente. Si el documento no existe, la regla fallar치 (comportamiento deseado)
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isSuperAdmin() {
      return isSignedIn() && getUserRole() == 'superadmin';
    }

    function isAdmin() {
      return isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'superadmin');
    }
    
    // -------------------------------------------------------------------------
    // Reglas para la colecci칩n de Usuarios (Roles)
    // -------------------------------------------------------------------------
    
    match /users/{userId} {
      // El usuario DEBE poder leer su propio documento para que la app cargue el rol
      allow get: if isOwner(userId) || isAdmin();
      
      // Permitir crear su propio perfil durante el registro
      allow create: if isOwner(userId);
      
      // Solo el superadmin gestiona permisos
      allow update, delete: if isSuperAdmin();
      allow list: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Reglas para Partners y sus Subcolecciones (Silos de datos)
    // -------------------------------------------------------------------------

    match /partners/{partnerId} {
      // Acceso al documento principal del partner
      allow get: if isOwner(partnerId) || isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isOwner(partnerId) || isSuperAdmin();

      // Regla recursiva para todas las subcolecciones (commissions, notifications)
      // Esto simplifica el c칩digo y mantiene la seguridad por partnerId
      match /{allSubcollections=**} {
        allow read: if isOwner(partnerId) || isAdmin();
        allow write: if isOwner(partnerId) || isSuperAdmin();
      }
    }
    
    // -------------------------------------------------------------------------
    // Colecci칩n Global de Pagos
    // -------------------------------------------------------------------------
    match /payments/{paymentId} {
      // SuperAdmin puede leer y escribir cualquier pago.
      allow read, write: if isSuperAdmin();
      
      // Los partners (admin) pueden leer sus propios pagos
      allow get: if isAdmin() && resource.data.partnerId == request.auth.uid;
      allow list: if isAdmin(); // La query en la app debe filtrar por partnerId

      // Los partners (admin) pueden crear sus propios pagos, pero no modificarlos ni borrarlos.
      allow create: if isAdmin() && request.resource.data.partnerId == request.auth.uid;
    }

    // -------------------------------------------------------------------------
    // Configuraciones Globales (Solo lectura para usuarios, escritura para Admin)
    // -------------------------------------------------------------------------

    match /commission_schemes/{schemeId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    match /rules/{ruleId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }
    
    match /saasPlatforms/{saasPlatformId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }
  }
}
